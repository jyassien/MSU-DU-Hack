<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <title>Forum for Issues</title>
</head>
<body>

  <!-- Navigation bar-->
  <div class="navbar">
    <a href="#home" onclick="filterPosts('home', undefined)">Home</a>
    <div class="dropdown">
      <button class="dropbtn">Campus
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-content">
        <a href="#Campus-News" onclick="filterPosts('Campus', 'News')">News</a>
        <a href="#Campus-Directions" onclick="filterPosts('Campus', 'Directions')">Directions</a>
        <a href="#Campus-Issues" onclick="filterPosts('Campus', 'Issues')">Issues</a>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn">Food
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-content">
        <a href="#Food-News" onclick="filterPosts('Food', 'News')">News</a>
        <a href="#Food-Reviews" onclick="filterPosts('Food', 'Reviews')">Reviews</a>
        <a href="#Food-Issues" onclick="filterPosts('Food', 'Issues')">Issues</a>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn">Dorms
        <i class="fa fa-caret-down"></i>
      </button>
      <div class="dropdown-content">
        <a href="#Dorms-News" onclick="filterPosts('Dorms', 'News')">News</a>
        <a href="#Dorms-Issues" onclick="filterPosts('Dorms', 'Issues')">Issues</a>
      </div>
    </div>
    <div class="login">
      <a href="#login">Login</a>
    </div>
  </div> 

<div class="topStuff">
   <!-- A button to open the popup form -->
   <button class="open-button" id="openNewPost" onclick="openForm()">New Post</button>

   <h1 id="location"></h1>
   
   <form>
     <input type="text" id="search"
     placeholder="Search...">
   </form>
</div>

<div class="sorting">
    <span>sort by</span>
    <button class="button-2">top</button>
    <button class="button-2">hot</button>
    <button class="button-2">new</button>
</div>


<!-- The new post submission form -->
<div class="form-popup" id="newPostForm">
  <form class="form-container" action="">
    <h1>New Post</h1>

    <label for="title"><b>Title</b></label>
    <input type="text" placeholder="Enter title" name="title" id="postTitle" required>

    <label for="desc"><b>Description</b></label>
    <input type="text" placeholder="Enter description" name="desc" id="postContent" required>

    <button type="submit" class="btn">Submit</button>
    <button type="button" class="btn cancel" onclick="closeForm()">Close</button>
  </form>
</div> 

<!-- Main container for all posts -->
<div id="mainContainer"></div>

<script>  
  // Database URL
  const firebaseDatabaseURL = "https://msuduhackton.firebaseio.com";
  
  // Add your auth token here
  const authToken = 'Qo48kLx2pbVoBJOC6dJhslRm35319dam4oOPwfwg';

  // Event Listener for form submission
  document.getElementById('newPostForm').children[0].addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Extract form field values
    const title = document.getElementById('postTitle').value;
    const content = document.getElementById('postContent').value;
    const category = window.location.hash.substr(1).split("-")[0];
    const community = window.location.hash.substr(1).split("-")[1];
    
    // Create a new post object
    const newPost = {
      title: title,
      content: content,
      upvotes: 0
    };
    
    // Firebase endpoint for storing posts
    const postUrl = `${firebaseDatabaseURL}/posts/${category}/${community}.json?auth=${authToken}`;
    console.log(postUrl);
    // Perform a POST request to Firebase
    fetch(postUrl, {
      method: 'POST',
      body: JSON.stringify(newPost)
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data);
      // Clear form fields
      document.getElementById('postTitle').value = '';
      document.getElementById('postContent').value = '';
      // Refresh posts
      filterPosts(category, community);
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  });

  window.addEventListener('DOMContentLoaded', function() {
    const hashPart = window.location.hash.substr(1);
    
    document.getElementById('location').textContent = hashPart;
    const category = hashPart.split("-")[0];
    const community = hashPart.split("-")[1];

    filterPosts(category, community);
  });

  // Function to filter and display posts
  function filterPosts(category, community) {
    if (community) {
      document.getElementById('location').textContent = `${category}-${community}`;
    } else {
      document.getElementById('location').textContent = `${category}`;
    }

    const fetchUrl = `${firebaseDatabaseURL}/posts/${category}/${community}.json?auth=${authToken}`;
    
    fetch(fetchUrl)
    .then(response => response.json())
    .then(data => updatePosts(data));
  }
  
  function updatePosts(posts) {
    const container = document.getElementById('mainContainer');
    container.innerHTML = '';
    for (const postId in posts) {
      const post = posts[postId];
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
  
      // Create a div for upvote button and vote count
      const upvoteInfo = document.createElement('div');
      upvoteInfo.className = 'upvote-info';

      // Create upvote button
      const upvoteButton = document.createElement('div');
      upvoteButton.className = 'upvote';
      upvoteButton.innerHTML = '&#9650;';
  
      // Create vote count
      const voteCount = document.createElement('div');
      voteCount.className = 'vote-count';
      voteCount.innerText = post.upvotes;

      // Create a div for post content
      
      const postContentDivParent = document.createElement('div');
      const postContentDiv = document.createElement('div');

      postContentDiv.className = 'post-content';
      postContentDiv.style.justifyContent = "space-evenly"

      // Create post content elements
      const postTitle = document.createElement('div');
      postTitle.className = 'post-title';
      postTitle.innerText = `Title: ${post.title}`;
  
      const postContent = document.createElement('div');
      postContent.className = 'post-content-text';
      postContent.innerText = `Content: ${post.content}`;

      upvoteButton.addEventListener('click', function() {
        post.upvotes++;
        voteCount.innerText = post.upvotes;
      });  
  
      // Append upvote button and vote count to the upvoteInfo div
      upvoteInfo.appendChild(upvoteButton);
      upvoteInfo.appendChild(voteCount);
      upvoteInfo.style.width = "50px";

  
      // Append post title and content to postContentDiv
      postContentDiv.appendChild(postTitle);
      postContentDiv.appendChild(postContent);

      postContentDivParent.appendChild(upvoteInfo)
      postContentDivParent.appendChild(postContentDiv)

      postDiv.appendChild(postContentDivParent);
      container.appendChild(postDiv);
      
      postContentDivParent.style.display = "flex";
      postContentDivParent.style.display = "flex";
    }
  }

function openForm() {
  document.getElementById("newPostForm").style.display = "block";
}

function closeForm() {
  document.getElementById("newPostForm").style.display = "none";
}

window.addEventListener('DOMContentLoaded', function() {
  const hashPart = window.location.hash.substr(1);
  
  const category = hashPart.split("-")[0];
  const community = hashPart.split("-")[1];

  filterPosts(category, community);
});

</script>
</body>
</html>
